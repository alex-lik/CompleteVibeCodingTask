name: E2E Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  # Start services for E2E testing
  setup-services:
    runs-on: ubuntu-latest

    outputs:
      backend-url: ${{ steps.start.outputs.backend-url }}
      frontend-url: ${{ steps.start.outputs.frontend-url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Start services with Docker Compose
      run: |
        docker-compose -f docker-compose.yml up -d
        echo "Waiting for services to be ready..."

        # Wait for backend health
        timeout 300 bash -c 'until curl -f http://localhost:80/health; do sleep 5; done'

        # Wait for frontend health
        timeout 300 bash -c 'until curl -f http://localhost:80/health; do sleep 5; done'

    - name: Output service URLs
      id: start
      run: |
        echo "backend-url=http://localhost:80/api" >> $GITHUB_OUTPUT
        echo "frontend-url=http://localhost:80" >> $GITHUB_OUTPUT

    - name: Show logs
      if: failure()
      run: |
        docker-compose -f docker-compose.yml logs

  # Backend E2E Tests
  backend-e2e:
    runs-on: ubuntu-latest
    needs: setup-services

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest httpx

    - name: Run E2E API tests
      run: |
        cd backend
        pytest tests/e2e/ -v --tb=short
      env:
        API_BASE_URL: ${{ needs.setup-services.outputs.backend-url }}

    - name: Run WebSocket E2E tests
      run: |
        cd backend
        python -m pytest tests/e2e/test_websocket_e2e.py -v
      env:
        WS_URL: ws://localhost:80/ws

  # Frontend E2E Tests
  frontend-e2e:
    runs-on: ubuntu-latest
    needs: setup-services

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Install Playwright
      run: |
        cd frontend
        npx playwright install --with-deps

    - name: Build application
      run: |
        cd frontend
        npm run build

    - name: Run Playwright E2E tests
      run: |
        cd frontend
        npx playwright test
      env:
        BASE_URL: ${{ needs.setup-services.outputs.frontend-url }}

    - name: Upload Playwright report
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: playwright-report
        path: frontend/playwright-report/
        retention-days: 7

  # Performance Tests
  performance-tests:
    runs-on: ubuntu-latest
    needs: setup-services
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install performance testing tools
      run: |
        pip install locust

    - name: Run load tests
      run: |
        # Example load test with locust
        echo "Running load tests..."
        # locust -f tests/performance/locustfile.py --headless -u 100 -r 10 -t 30s --host ${{ needs.setup-services.outputs.backend-url }}

  # Cleanup
  cleanup:
    runs-on: ubuntu-latest
    needs: [backend-e2e, frontend-e2e, performance-tests]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Stop services
      run: |
        docker-compose -f docker-compose.yml down -v
        docker system prune -f